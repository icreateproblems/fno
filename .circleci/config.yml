version: 2.1

# Orbs provide reusable packages of configuration
orbs:
  python: circleci/python@2.1.1

# Define the jobs
jobs:
  fetch-and-post:
    docker:
      - image: cimg/python:3.11
    
    resource_class: small  # Use smallest to save credits
    
    steps:
      - checkout
      
      # Ensure we're on the latest main branch (fix for stale checkout)
      - run:
          name: Reset to latest main
          command: |
            git fetch origin main
            git reset --hard origin/main
            echo "‚úÖ Reset to latest main branch"
            git log -1 --oneline
      
      # Clear Python cache to prevent stale imports
      - run:
          name: Clear Python cache
          command: |
            find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
            find . -type f -name "*.pyc" -delete 2>/dev/null || true
            echo "‚úÖ Python cache cleared"
      
      # Verify imports before running
      - run:
          name: Verify config imports
          command: |
            echo "üîç Checking git commit..."
            git log -1 --oneline
            echo ""
            echo "üîç Checking fetch_news.py imports..."
            head -30 scripts/fetch_news.py | grep -A 8 "from app.config import"
            echo ""
            echo "üîç Testing config imports..."
            python -c "from app.config import FREE_RSS_SOURCES, CLEANUP_DAYS; print(f'‚úÖ Config imports verified: {len(FREE_RSS_SOURCES)} RSS sources, cleanup {CLEANUP_DAYS} days')" || (echo "‚ùå Config import failed!"; exit 1)
      
      # Restore pip cache
      - restore_cache:
          keys:
            - pip-cache-v1-{{ checksum "requirements.txt" }}
            - pip-cache-v1-
      
      # Install dependencies
      - run:
          name: Install dependencies
          command: |
            python -m pip install --upgrade pip
            pip install -r requirements.txt
      
      # Save pip cache
      - save_cache:
          key: pip-cache-v1-{{ checksum "requirements.txt" }}
          paths:
            - ~/.cache/pip
      
      # Setup Environment (Instagram Graph API)
      - run:
          name: Verify environment variables
          command: |
            echo "üîß Verifying Instagram Graph API credentials..."
            
            # Check required variables
            if [ -z "$INSTAGRAM_ACCESS_TOKEN" ]; then
              echo "‚ùå ERROR: INSTAGRAM_ACCESS_TOKEN not set!"
              exit 1
            fi
            
            if [ -z "$INSTAGRAM_BUSINESS_ACCOUNT_ID" ]; then
              echo "‚ùå ERROR: INSTAGRAM_BUSINESS_ACCOUNT_ID not set!"
              exit 1
            fi
            
            if [ -z "$IMGBB_API_KEY" ]; then
              echo "‚ùå ERROR: IMGBB_API_KEY not set!"
              exit 1
            fi
            
            echo "‚úÖ Instagram Graph API credentials configured"
            echo "‚úÖ Using Instagram Business Account ID: ${INSTAGRAM_BUSINESS_ACCOUNT_ID}"
      
      # Fetch breaking news
      - run:
          name: Fetch breaking news
          command: |
            export SUPABASE_URL="${SUPABASE_URL}"
            export SUPABASE_KEY="${SUPABASE_KEY}"
            python scripts/fetch_news.py
      
      # Post to Instagram via Graph API
      - run:
          name: Post to Instagram
          command: |
            export SUPABASE_URL="${SUPABASE_URL}"
            export SUPABASE_KEY="${SUPABASE_KEY}"
            export GROQ_API_KEY="${GROQ_API_KEY}"
            export INSTAGRAM_ACCESS_TOKEN="${INSTAGRAM_ACCESS_TOKEN}"
            export INSTAGRAM_BUSINESS_ACCOUNT_ID="${INSTAGRAM_BUSINESS_ACCOUNT_ID}"
            export INSTAGRAM_APP_ID="${INSTAGRAM_APP_ID}"
            export IMGBB_API_KEY="${IMGBB_API_KEY}"
            python scripts/post_instagram_graph.py
          # Don't fail workflow if no stories to post
          when: always

# Workflows orchestrate jobs
workflows:
  version: 2
  
  # Anti-Detection Schedule:
  # Runs frequently but posts randomly (avoids bot detection)
  # - Checks every 10 minutes = 144 runs/day
  # - Random scheduler decides when to actually post (30-40 posts/day)
  # - Variable intervals (20-90 min) = appears human-like
  # - No predictable pattern = avoids Instagram/CircleCI flags
  scheduled-fetch:
    triggers:
      - schedule:
          # Check every 10 minutes, but only post when random scheduler allows
          # This creates unpredictable posting patterns (human-like)
          cron: "*/10 * * * *"
          filters:
            branches:
              only:
                - main
    jobs:
      - fetch-and-post

  # Manual trigger workflow (runs on git push to main)
  manual-run:
    jobs:
      - fetch-and-post:
          filters:
            branches:
              only:
                - main
