stages:
  - fetch-and-post

# Random Posting System for GitLab CI
# - Runs every 12 minutes (120 checks/day)
# - Only posts when random scheduler allows (10-15 posts/day)
# - Total: ~480 minutes/month (unlimited for public repos)

fetch-post-job:
  stage: fetch-and-post
  image: python:3.11-slim
  
  # Run every 12 minutes = 120 times/day
  # Random scheduler decides when to actually post
  # Creates unpredictable, human-like patterns
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
    - if: '$CI_PIPELINE_SOURCE == "web"'
    - if: '$CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == "main"'
  
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - .cache/pip
  
  before_script:
    - echo "üîß Setting up environment..."
    - apt-get update -qq && apt-get install -y -qq git
    - echo "üßπ Clearing Python cache..."
    - find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
    - find . -type f -name "*.pyc" -delete 2>/dev/null || true
    - python -m pip install --upgrade pip
    - pip install -r requirements.txt --cache-dir .cache/pip
    - echo "üîç Verifying config imports..."
    - python -c "from app.config import FREE_RSS_SOURCES, CLEANUP_DAYS; print(f'‚úÖ Config verified - {len(FREE_RSS_SOURCES)} RSS sources, cleanup {CLEANUP_DAYS} days')"
  
  script:
    - echo "üì° Fetching news from RSS sources..."
    - python scripts/fetch_news.py || echo "‚ö†Ô∏è Fetch completed with warnings"
    
    - echo "üé≤ Checking random scheduler..."
    - |
      python -c "from app.random_scheduler import should_attempt_post
      import sys
      if not should_attempt_post():
          print('‚è≥ Not time to post yet - waiting for next random interval')
          sys.exit(0)
      print('‚úÖ Random scheduler says: Time to post!')"
    
    - echo "üì∏ Posting to Instagram (if scheduler allowed)..."
    - python scripts/post_instagram_graph.py || echo "‚ö†Ô∏è Post completed with warnings"
  
  environment:
    name: production
  
  # Resource optimization
  timeout: 10m
  interruptible: true
  
  # Store scheduler state as artifact (for coordination)
  artifacts:
    paths:
      - scheduler_state.json
    expire_in: 1 day
    when: always

# Nightly cleanup job
cleanup-job:
  stage: fetch-and-post
  image: python:3.11-slim
  
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule" && $CLEANUP_JOB == "true"'
  
  before_script:
    - pip install -r requirements.txt --cache-dir .cache/pip
  
  script:
    - echo "üßπ Running daily cleanup..."
    - python scripts/cleanup_old_stories.py || true
  
  timeout: 5m

# Variables (set in GitLab CI/CD Settings ‚Üí Variables)
variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  PYTHONUNBUFFERED: "1"
  
# Required secrets (add in GitLab):
# - SUPABASE_URL
# - SUPABASE_KEY
# - GROQ_API_KEY
# - INSTAGRAM_ACCESS_TOKEN
# - INSTAGRAM_BUSINESS_ACCOUNT_ID
# - IMGBB_API_KEY
